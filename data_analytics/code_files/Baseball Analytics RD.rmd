---
title: "Baseball Analytics"
author: "Neal Kapur"
date: "2022-09-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Part 1:
Last season, our third baseman Mac Horvath started out in a slump. As the season went on, he worked with our hitting coach to make adjustments. Suppose that at the end of the season, our hitting coach comes to you requesting to know how Mac’s adjustments affected his performance. Use TrackMan data to identify the effects of Mac’s adjustments, interpret how these effects might be related, and show whether his adjustments were successful.
<br>
<br>
**Theory:** Mac Horvath improved throughout the semester after working with the hitting coach. 
<br>
**Process:** To determine the effect of the hitting coach's adjustment on Mac's performance throughout the game, I evaluated the cumulative number of runs scored for months where Mac batted at similar amounts. The number of Runs Scored per month and a detailed breakdown of the result of the play - Single, Double, Triple, and HomeRun are all displayed below. 
<br>
<br>
```{r, echo=FALSE, include=FALSE}
library("readr")
library("tidyverse")
library("dplyr")
tmData22 <- read_csv("Downloads/2022 TrackMan Data.csv")
```

```{r, include = FALSE}
library("anytime")
macbat <- tmData22 %>% filter(Batter == "Horvath, Mac")
gd <- macbat
```


```{r, include = FALSE}
gd$month <- substr(gd$Date,1,1) 

Singles <- c(sum(gd$month == 3 & gd$PlayResult == "Single"), sum(gd$month == 4 & gd$PlayResult == "Single"), sum(gd$month == 5 & gd$PlayResult == "Single"))
             

           
Doubles  <- c(sum(gd$month == 3 & gd$PlayResult == "Double"), sum(gd$month == 4 & gd$PlayResult == "Double"), sum(gd$month == 5 & gd$PlayResult == "Double"))
              

Triples <- c(sum(gd$month == 3 & gd$PlayResult == "Triple"),sum(gd$month == 4 & gd$PlayResult == "Triple"), sum(gd$month == 5 & gd$PlayResult == "Triple"))

HomeRun <- c(sum(gd$month == 3 & gd$PlayResult == "HomeRun"),sum(gd$month == 4 & gd$PlayResult == "HomeRun"), sum(gd$month == 5 & gd$PlayResult == "HomeRun"))

# === Row-Oriented Display ====
March <- c(sum(gd$month == 3 & gd$PlayResult == "Single"), sum(gd$month == 3 & gd$PlayResult == "Double"), sum(gd$month == 3 & gd$PlayResult == "Triple"), sum(gd$month == 3 & gd$PlayResult == "HomeRun"))

April <- c(sum(gd$month == 4 & gd$PlayResult == "Single"), sum(gd$month == 4 & gd$PlayResult == "Double"),sum(gd$month == 4 & gd$PlayResult == "Triple"), sum(gd$month == 4 & gd$PlayResult == "HomeRun"))

May <- c(sum(gd$month == 5 & gd$PlayResult == "Single"), sum(gd$month == 5 & gd$PlayResult == "Double"), sum(gd$month == 5 & gd$PlayResult == "Triple"), sum(gd$month == 5 & gd$PlayResult == "HomeRun"))

breakdown <- cbind(Singles, Doubles, Triples, HomeRun)
rownames(breakdown) <- c("March", "April", "May")
colnames(breakdown) <- c("Singles", "Doubles", "Triples", "HomeRun")
breakdown.reverse <- cbind(March, April, May)
rownames(breakdown.reverse) <- c("Singles", "Doubles", "Triples", "HomeRun")
colnames(breakdown.reverse) <- c("March", "April", "May") 
breakdown.reverse
```

```{r, include = FALSE}
gd %>% count(month)
# Drop the months where for 2 and 3 as there are only 127 and 115 at bats. 

# Presents only data findings where the month is significant. 
# We know that month 3, 4, 5 have n-values greater than 300.
df <- gd %>% filter(month %in% c("3", "4", "5"))
```


```{r, include = FALSE }
library(lubridate)
bymonth <- aggregate(df,RunsScored~month, FUN=sum)
as_tibble(bymonth)
```

```{r, include = FALSE}
bymonth$bats <- pull(df %>% count(month), var = 2)
class(bymonth)
```
<br>
<br>
```{r, echo = FALSE}
ggplot(data = bymonth, aes(x = month, y = bats)) + geom_bar(stat = "identity", fill = "green")+ labs(title = ("Number of Swings per Month."), x=("Month"), y=("Swings"))
```
<br>
*Describes the number of times that Mac appears to bat at Homeplate by month. Where Month 3 is March, Month 4 is April and Month 5 is May.*
<br>
<br>
```{r, echo = FALSE}
ggplot(data = bymonth, aes(x = month, y = RunsScored)) + geom_bar(stat = "identity", fill = "blue") + labs(title = ("Cumulative Runs by Month"), x="Month", y= "Runs")
```
<br>
*Describes the total number of run plays that Mac generated from March - May.*


```{r, include = FALSE}
library(lubridate)
# df = aggregate(RunsScored~Date, data = macbat,FUN = sum)
```
<br>
<br>
```{r, echo = FALSE}

barplot(height = breakdown.reverse,
        main = "Breakdown of Runs by Mac Horvath",
        xlab = "Month", ylab = "Frequency",
        col = c("darkgrey", "darkblue", "red", "purple"),
        legend.text = rownames(breakdown.reverse),
        beside = TRUE)
```
<br>
*Shows an increasing number of high-run play generated by Mac spanning the months of March-May*
<br>
<br>

```{r, include=FALSE}
# At Bat: a batter reaches base via a fielder's choice, hit or an error (not including catcher's interference) or when a batter is put out on a non-sacrifice.
hits.defined <- c("Single", "Double", "Triple","HomeRun")
at.bats.defined <- c("Single", "Double", "FieldersChoice","Triple","HomeRun","Out")
at.bats <- as.numeric(count(macbat %>% filter(PlayResult %in% at.bats.defined)))
hits.total <- as.numeric(count(macbat %>% filter(PlayResult %in% hits.defined)))
```

```{r, include = FALSE}

batting.average.monthly <- function(m){
  hits.month <- as.numeric(count(df %>% filter(PlayResult %in% hits.defined, month == m)))
  bats.month <- as.numeric(count(df %>% filter(PlayResult %in% at.bats.defined, month == m)))
  batting.average <- hits.month/bats.month
  return(round(batting.average, 3))
}
hits.march <- batting.average.monthly(3)
hits.april <- batting.average.monthly(4)
hits.may <- batting.average.monthly(5)

cum.batting.average <- round((hits.total/at.bats), 3)
cum.batting.average
hits.march
```

```{r, include = FALSE }
at.bats <- as.numeric(at.bats)
```

```{r, include = FALSE}
library("kableExtra")
```
```{r, echo=FALSE}
bat.avg.cum <- data.frame(Month = c("March", "April", "May", "Total"), Average = c(hits.march, hits.april, hits.may, cum.batting.average))
bat.avg.cum %>%
  kbl(caption = "Batting Averages For Mac Horvath") %>% 
  kable_classic_2() %>% 
  row_spec(4, bold = T, background = "#FFFF99")
```

<br>
**Conclusion:** As seen by the charts above, during March, April and May - Mac Horvath had a similar number of total swings while at Bat. However, during April and May, the number of Runs Mac created for the team increased. Furthermore, Mac also hit more Doubles, Triples, and Homeruns for the team. As seen by the cumulative statistic described by the batting average, Mac's batting average also increased throughout these three months while his "At Bats" remained similar. If Mac continues to show an upward trend in his monthly batting averages, his cumulative batting average for next season will be much higher. 
<br>

# Part 3:
Our closer, Davis Palermo, has heard that analytical MLB teams value pitchers whose fastballs have strong measurements of Induced Vertical Break, Vertical Approach Angle, Spin Rate, and Velocity. He understands that these are important, but doesn’t completely understand why. Using data visualizations and written word, prove to Davis the connection between these TrackMan measurements and successful performance. Feel free to use data of all of our pitchers,not only Davis’s data. 
<br>
<br>
**Pitching Variables Being Tested:**

1. Induced Vertical Break
<br>
2. Vertical Approach Angle
<br>
3. SpinRate 
<br>
4. Velocity
<br>
<br>
**Theory:** A player will throw more fastballs that result in Outs and strikeouts while throwing less pitches that result in "Single", "Double" and "Home runs" if he has strong measurements in Induced Vertical Break, Vertical Approach Angle, Spin Rate, and Velocity.
<br> 
<br>
**Process:** I researched what is considered **Ideal** when it comes to the Pitching variables that were tested. Then I compared the outcomes of throwing fastballs where three or more of these variables were in the ideal range to throwing fastballs where three or more variables were in the poor/not ideal range. 
<br>
<br>
**Strong Fastball:** A strong Fastball is defined as having:

* Induced Vertical Break - greater than or equal to 17 inches.
* Vertical Approach Angle - Less than or equal to  -6.9 degrees.
* Effective Velocity - Greater than or equal to 90 MPH.
* Spin Rate - Greater than 2600 Rotations Per Minute (RPM) OR less than 1800 RPM.

**Weak Fastball:** A weak fastball is defined as having:

* Induced Vertical Break - Less than or equal to 13.396 inches
* Vertical Approach Angle - Greater than or equal to -5.54 degrees.
* Effective Velocity - Less than or equal to 86.72 MPH
* Spin Rate - Between 1800 and 2600 RPM
<br>
<br>
*NOTE:* Data was resampled so the number of Weak and Strong Fastballs analyzed was 111. 

```{r, include=FALSE}
fastballs <- tmData22 %>% filter(TaggedPitchType == "FB")

```
```{r, include = FALSE}
summary(fastballs$InducedVertBreak) # good Induced Vertical break is around 17+
summary(fastballs$SpinRate) #Fastballs below 1800 RPM And Above 2600 RPM the most effective. 
```

```{r, include = FALSE}
summary(fastballs$VertApprAngle)
```


```{r, include = FALSE}
summary(fastballs$EffectiveVelo) #Looking for the highest velocity Fastball. 
# Average velocity of MLB pitchers = 91.7 MPH

```


```{r, include = FALSE}
# === Strong Fastballs === 
tests <- c("fastballs$InducedVertBreak >= 17", "fastballs$VertApprAngle <= -6.9", "fastballs$EffectiveVelo >= 90" , "fastballs$SpinRate > 2600 | fastballs$SpinRate < 1800")
res <- sapply(tests, FUN = function(txt){eval(parse(text=txt))})
apply(res, 1, sum)
strong.fastballs.dirt <- fastballs[apply(res,1,sum) >=3,] # Greater than or equal to three of the above conditions are met.
sf.clean <- data.frame(strong.fastballs.dirt)
sf.clean <- sf.clean[complete.cases(sf.clean$PitchNo),]
sf.clean # Strong fastballs where three or more conditions are met and 
sf <- sf.clean %>% count(PlayResult)
sf <- sf[-c(1),]
sf
```

```{r, include = FALSE}
# === Strong Fastballs === 
tester <- c("fastballs$InducedVertBreak <= 13.396", "fastballs$VertApprAngle >= -5.54", "fastballs$EffectiveVelo <= 86.72" , "fastballs$SpinRate < 2600 | fastballs$SpinRate > 1800")
res <- sapply(tester, FUN = function(txt){eval(parse(text=txt))})
apply(res, 1, sum)
weak.fastballs.dirt <- fastballs[apply(res,1,sum) >=4,] # Greater than or equal to three of the above conditions are met.
wf.clean <- data.frame(weak.fastballs.dirt)
wf.clean <- wf.clean[complete.cases(wf.clean$PitchNo),]
wf.clean # Strong fastballs where three or more conditions are met and 
```
```{r, include = FALSE}
wf.clean <- sample_n(wf.clean, 111)
wf <- wf.clean %>% count(PlayResult)
wf <- wf[-c(1, 2, 5),]
wf.matrix <- cbind(freq = c(wf$n))
rownames(wf.matrix) <- c(wf$PlayResult)
colnames(wf.matrix) <- c("PlayResult")
rownames(wf.matrix)
```
```{r, include = FALSE}
library(reshape2)
```

```{r, echo = FALSE}
barplot(height = wf.matrix,
        main = "Breakdown of 'Weak' Fastballs",legend.text = rownames(wf.matrix),col = c("blue", "green", "grey", "purple", "lightblue"), ylab = "Frequency",
        beside = TRUE)
```
<br>
*Weak Fastballs often end in either a Single or an Out*
```{r, include = FALSE}

sf %>% arrange(factor(PlayResult, levels = c("HitByPitch", "Out", "Single", "Strikeout", "Walk", "Double")))

```
```{r, echo = FALSE}
sf.matrix <- cbind(freq = c(sf$n))
rownames(sf.matrix) <- c(sf$PlayResult)
colnames(sf.matrix) <- c("PlayResult")
barplot(height = sf.matrix,
        main = "Breakdown of 'Strong' Fastballs",legend.text = rownames(sf.matrix),col = c("blue", "green", "grey", "purple", "lightblue"), ylab = "Frequency", args.legend = list(x = "left", inset = c(0,2)),
        beside = TRUE)
```
<br>
*As one can see Batters faced with 'strong' fastballs Struck out at a higher rate then batters that were faced with 'weaker' fastballs.*
<br>
<br>
**Conclusion:** As one can see, the strong fastballs where pitches met at least three of the ideal ranges for the Pitching Variables that Davis asked to isolate performed much better when it comes to overall PlayResult. Batter's faced with Fastballs where the SpinRate, Velocity, Induced Vertical Break, and Vertical Approach Angle were in ideal MLB ranges performed worse than with Fastballs where this was not the case. An exciting caveat that this analysis brought up is that when batters can hit these 'stronger' fastballs, the Play Result is more often a double than a single. My analysis supports the theory that these variables are necessary for analytically minded baseball teams to consider and essential for players to focus on when improving their game.  

